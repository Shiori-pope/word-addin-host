<!doctype html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Microsoft 登录</title><script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script><style>body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-sizing: border-box;
        }
        .container {
            text-align: center;
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h2 { margin: 0; font-size: 18px; font-weight: 400; }
        p { margin: 10px 0 0; font-size: 14px; opacity: 0.8; }
        .error { color: #ffcdd2; }</style></head><body><div class="container"><div class="spinner" id="spinner"></div><h2 id="status">正在完成登录...</h2><p id="message">请稍候</p></div><script>/**
         * Office Dialog API 认证页面
         * 
         * 流程：
         * 1. 主窗口打开此页面，带上 ?startAuth=true 参数
         * 2. 此页面重定向到 Azure AD 登录
         * 3. Azure AD 登录后重定向回此页面，URL fragment 中包含 access_token
         * 4. 解析 token
         * 5. 使用 Office.context.ui.messageParent 发送给主窗口
         */
        
        // Azure AD 配置
        var CLIENT_ID = 'aa584c91-54b8-4109-a3ad-635b43cf5478';
        var TENANT_ID = '2cd5468c-1faa-4ddc-96ee-1f4a51a21c86';
        
        // 解析 URL fragment 中的参数
        function parseHash(hash) {
            if (!hash || hash.length <= 1) return {};
            
            var params = {};
            var pairs = hash.substring(1).split('&');
            for (var i = 0; i < pairs.length; i++) {
                var pair = pairs[i].split('=');
                if (pair[0] && pair[1]) {
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
            return params;
        }
        
        // 解析 URL query 中的参数
        function parseQuery(search) {
            if (!search || search.length <= 1) return {};
            
            var params = {};
            var pairs = search.substring(1).split('&');
            for (var i = 0; i < pairs.length; i++) {
                var pair = pairs[i].split('=');
                if (pair[0] && pair[1]) {
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                }
            }
            return params;
        }
        
        // 构建 Azure AD 登录 URL
        function buildAuthUrl() {
            // 修正：支持 GitHub Pages 子目录路径
            var currentUrl = window.location.href.split('?')[0];
            var redirectUri = encodeURIComponent(currentUrl);
            var scopes = encodeURIComponent([
                'api://shiori-pope.github.io/aa584c91-54b8-4109-a3ad-635b43cf5478/access_as_user',
                'openid',
                'profile', 
                'email'
            ].join(' '));
            var nonce = Math.random().toString(36).substring(2);
            
            return 'https://login.microsoftonline.com/' + TENANT_ID + '/oauth2/v2.0/authorize?' +
                'client_id=' + CLIENT_ID +
                '&response_type=token' +
                '&redirect_uri=' + redirectUri +
                '&scope=' + scopes +
                '&nonce=' + nonce +
                '&prompt=select_account';
        }
        
        // 发送消息给父窗口
        function sendMessage(message) {
            console.log('[Dialog] Sending message:', JSON.stringify(message));
            
            Office.onReady(function() {
                console.log('[Dialog] Office ready, sending message');
                try {
                    Office.context.ui.messageParent(JSON.stringify(message));
                } catch (e) {
                    console.error('[Dialog] Failed to send message:', e);
                }
            });
        }
        
        // 主逻辑
        (function() {
            console.log('[Dialog] Page loaded');
            console.log('[Dialog] URL:', window.location.href);
            
            var hashParams = parseHash(window.location.hash);
            var queryParams = parseQuery(window.location.search);
            
            console.log('[Dialog] Hash params:', Object.keys(hashParams));
            console.log('[Dialog] Query params:', Object.keys(queryParams));
            
            // 情况1：收到 access_token（从 Azure AD 返回）
            if (hashParams.access_token) {
                console.log('[Dialog] Access token found!');
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('status').textContent = '登录成功';
                document.getElementById('message').textContent = '正在返回应用...';
                
                sendMessage({
                    success: true,
                    accessToken: hashParams.access_token,
                    tokenType: hashParams.token_type,
                    expiresIn: hashParams.expires_in,
                    scope: hashParams.scope
                });
                return;
            }
            
            // 情况2：收到错误
            if (hashParams.error || queryParams.error) {
                var error = hashParams.error || queryParams.error;
                var errorDesc = hashParams.error_description || queryParams.error_description || '未知错误';
                
                console.error('[Dialog] Auth error:', error);
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('status').textContent = '登录失败';
                document.getElementById('message').textContent = decodeURIComponent(errorDesc.replace(/\+/g, ' '));
                
                sendMessage({
                    success: false,
                    error: error,
                    errorDescription: errorDesc
                });
                return;
            }
            
            // 情况3：首次加载，需要跳转到 Azure AD
            if (queryParams.startAuth === 'true') {
                console.log('[Dialog] Starting auth flow...');
                document.getElementById('status').textContent = '正在跳转到登录页面...';
                
                // 延迟一下再跳转，确保 Office.js 加载完成
                setTimeout(function() {
                    var authUrl = buildAuthUrl();
                    console.log('[Dialog] Redirecting to:', authUrl);
                    window.location.href = authUrl;
                }, 500);
                return;
            }
            
            // 情况4：没有任何参数，可能是直接访问
            console.log('[Dialog] No auth params, showing instructions');
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status').textContent = '请从应用中登录';
            document.getElementById('message').textContent = '请关闭此窗口并从 Word 插件中重新登录';
        })();</script></body></html>