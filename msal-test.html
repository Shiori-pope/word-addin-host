<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MSAL Popup éš”ç¦»æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #106ebe; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-entry.info { border-left-color: #0078d4; color: #0078d4; }
        .log-entry.success { border-left-color: #107c10; color: #107c10; }
        .log-entry.error { border-left-color: #d13438; color: #d13438; }
        .log-entry.warn { border-left-color: #ff8c00; color: #ff8c00; }
        .config {
            background: #fff4e6;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .config pre {
            margin: 5px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” MSAL Popup éš”ç¦»æµ‹è¯•</h1>
        
        <div class="config">
            <strong>æµ‹è¯•é…ç½®:</strong>
            <pre id="configDisplay"></pre>
        </div>

        <div>
            <button id="testPopup">1. æµ‹è¯• Popup ç™»å½•</button>
            <button id="checkCache">2. æ£€æŸ¥ç¼“å­˜çŠ¶æ€</button>
            <button id="clearCache">3. æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
            <button id="testSilent">4. æµ‹è¯•é™é»˜è·å–</button>
        </div>

        <div class="log" id="logContainer">
            <div class="log-entry info">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <!-- MSAL.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.7.1/lib/msal-browser.min.js"></script>
    
    <script>
        // MSAL é…ç½®ï¼ˆä¸å®é™…é¡¹ç›®ä¸€è‡´ï¼‰
        const msalConfig = {
            auth: {
                clientId: 'aa584c91-54b8-4109-a3ad-635b43cf5478',
                authority: 'https://login.microsoftonline.com/2cd5468c-1faa-4ddc-96ee-1f4a51a21c86',
                redirectUri: window.location.origin + '/redirect.html',
                navigateToLoginRequestUrl: false,
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: true,
                secureCookies: false,
            },
            system: {
                windowHashTimeout: 60000,
                iframeHashTimeout: 6000,
                loadFrameTimeout: 0,
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) return;
                        log(`[MSAL ${level}] ${message}`, 'info');
                    }
                }
            }
        };

        const loginRequest = {
            scopes: [
                'api://aa584c91-54b8-4109-a3ad-635b43cf5478/access_as_user',
                'openid',
                'profile',
                'email'
            ],
            prompt: 'select_account'
        };

        // æ˜¾ç¤ºé…ç½®
        document.getElementById('configDisplay').textContent = JSON.stringify({
            clientId: msalConfig.auth.clientId,
            redirectUri: msalConfig.auth.redirectUri,
            scopes: loginRequest.scopes,
            cacheLocation: msalConfig.cache.cacheLocation,
            storeAuthStateInCookie: msalConfig.cache.storeAuthStateInCookie
        }, null, 2);

        let msalInstance = null;
        const logContainer = document.getElementById('logContainer');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        async function initMSAL() {
            if (msalInstance) return msalInstance;

            try {
                log('æ­£åœ¨åˆå§‹åŒ– MSAL...', 'info');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                log('âœ… MSAL åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å®šå‘å“åº”
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    log('æ£€æµ‹åˆ°é‡å®šå‘å“åº”: ' + response.account.username, 'success');
                }
                
                return msalInstance;
            } catch (error) {
                log('âŒ MSAL åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                throw error;
            }
        }

        // æŒ‰é’® 1: æµ‹è¯• Popup ç™»å½•
        document.getElementById('testPopup').addEventListener('click', async () => {
            log('========== å¼€å§‹ Popup ç™»å½•æµ‹è¯• ==========', 'info');
            
            try {
                const instance = await initMSAL();
                
                log('è·å–å½“å‰è´¦æˆ·...', 'info');
                const accounts = instance.getAllAccounts();
                log(`å½“å‰è´¦æˆ·æ•°é‡: ${accounts.length}`, 'info');
                
                if (accounts.length > 0) {
                    log('å·²æœ‰è´¦æˆ·: ' + accounts[0].username, 'info');
                }

                log('å‡†å¤‡æ‰“å¼€ popup çª—å£...', 'warn');
                log('è¯·æ±‚çš„ scopes: ' + JSON.stringify(loginRequest.scopes), 'info');
                
                // å…³é”®æµ‹è¯•ç‚¹ï¼špopup ç™»å½•
                const response = await instance.loginPopup(loginRequest);
                
                log('âœ… Popup ç™»å½•æˆåŠŸï¼', 'success');
                log('ç”¨æˆ·: ' + response.account.username, 'success');
                log('AccessToken é•¿åº¦: ' + response.accessToken.length, 'success');
                log('Scopes: ' + response.scopes.join(', '), 'success');
                
            } catch (error) {
                log('âŒ Popup ç™»å½•å¤±è´¥', 'error');
                log('é”™è¯¯ä»£ç : ' + (error.errorCode || 'unknown'), 'error');
                log('é”™è¯¯æ¶ˆæ¯: ' + (error.errorMessage || error.message), 'error');
                log('å­é”™è¯¯: ' + (error.subError || 'none'), 'error');
                
                if (error.errorCode === 'no_token_request_cache_error') {
                    log('', 'error');
                    log('âš ï¸ æ£€æµ‹åˆ° no_token_request_cache_error', 'warn');
                    log('å¯èƒ½åŸå› :', 'warn');
                    log('1. redirect.html æœªæ­£ç¡®å¤„ç†å“åº”', 'warn');
                    log('2. sessionStorage åœ¨çª—å£é—´æœªå…±äº«', 'warn');
                    log('3. popup çª—å£è¢«æå‰å…³é—­', 'warn');
                    log('4. MSAL é…ç½®ä¸ä¸€è‡´', 'warn');
                }
            }
        });

        // æŒ‰é’® 2: æ£€æŸ¥ç¼“å­˜çŠ¶æ€
        document.getElementById('checkCache').addEventListener('click', async () => {
            log('========== æ£€æŸ¥ç¼“å­˜çŠ¶æ€ ==========', 'info');
            
            try {
                const instance = await initMSAL();
                
                // æ£€æŸ¥ sessionStorage
                log('SessionStorage é”®å€¼:', 'info');
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key.includes('msal') || key.includes('login')) {
                        const value = sessionStorage.getItem(key);
                        log(`  ${key}: ${value.substring(0, 50)}...`, 'info');
                    }
                }
                
                // æ£€æŸ¥ cookies
                log('', 'info');
                log('Cookies:', 'info');
                const cookies = document.cookie.split(';');
                cookies.forEach(cookie => {
                    if (cookie.includes('msal')) {
                        log(`  ${cookie.trim()}`, 'info');
                    }
                });
                
                // æ£€æŸ¥è´¦æˆ·
                log('', 'info');
                const accounts = instance.getAllAccounts();
                log(`è´¦æˆ·æ•°é‡: ${accounts.length}`, 'info');
                accounts.forEach((account, index) => {
                    log(`  è´¦æˆ· ${index + 1}: ${account.username}`, 'info');
                    log(`    ç¯å¢ƒ: ${account.environment}`, 'info');
                    log(`    homeAccountId: ${account.homeAccountId}`, 'info');
                });
                
            } catch (error) {
                log('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æŒ‰é’® 3: æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        document.getElementById('clearCache').addEventListener('click', () => {
            log('========== æ¸…é™¤æ‰€æœ‰ç¼“å­˜ ==========', 'warn');
            
            try {
                // æ¸…é™¤ sessionStorage
                const sessionKeys = Object.keys(sessionStorage);
                sessionStorage.clear();
                log(`âœ… æ¸…é™¤ sessionStorage (${sessionKeys.length} é¡¹)`, 'success');
                
                // æ¸…é™¤ localStorage
                const localKeys = Object.keys(localStorage);
                localStorage.clear();
                log(`âœ… æ¸…é™¤ localStorage (${localKeys.length} é¡¹)`, 'success');
                
                // æ¸…é™¤ cookies
                const cookies = document.cookie.split(';');
                cookies.forEach(cookie => {
                    const name = cookie.split('=')[0].trim();
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                });
                log(`âœ… æ¸…é™¤ cookies (${cookies.length} é¡¹)`, 'success');
                
                // é‡ç½® MSAL å®ä¾‹
                msalInstance = null;
                log('âœ… é‡ç½® MSAL å®ä¾‹', 'success');
                
                log('', 'success');
                log('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤ï¼åˆ·æ–°é¡µé¢ç”Ÿæ•ˆã€‚', 'success');
                
            } catch (error) {
                log('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æŒ‰é’® 4: æµ‹è¯•é™é»˜è·å–
        document.getElementById('testSilent').addEventListener('click', async () => {
            log('========== æµ‹è¯•é™é»˜è·å– Token ==========', 'info');
            
            try {
                const instance = await initMSAL();
                const accounts = instance.getAllAccounts();
                
                if (accounts.length === 0) {
                    log('âŒ æ²¡æœ‰è´¦æˆ·ï¼Œè¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                log('ä½¿ç”¨è´¦æˆ·: ' + accounts[0].username, 'info');
                
                const silentRequest = {
                    ...loginRequest,
                    account: accounts[0]
                };
                
                const response = await instance.acquireTokenSilent(silentRequest);
                
                log('âœ… é™é»˜è·å–æˆåŠŸï¼', 'success');
                log('AccessToken é•¿åº¦: ' + response.accessToken.length, 'success');
                
            } catch (error) {
                log('âŒ é™é»˜è·å–å¤±è´¥', 'error');
                log('é”™è¯¯: ' + (error.errorCode || error.message), 'error');
                
                if (error.name === 'InteractionRequiredAuthError') {
                    log('éœ€è¦ç”¨æˆ·äº¤äº’ï¼Œè¯·ä½¿ç”¨ Popup ç™»å½•', 'warn');
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            log('æµè§ˆå™¨: ' + navigator.userAgent, 'info');
            log('å½“å‰ URL: ' + window.location.href, 'info');
            
            try {
                await initMSAL();
            } catch (error) {
                log('è‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥ï¼Œéœ€æ‰‹åŠ¨æ“ä½œ', 'warn');
            }
        });
    </script>
</body>
</html>
